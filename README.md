# README: Скрипт выгрузки сделок из Bitrix24

## Назначение

Скрипт получает данные о сделках из Bitrix24 через REST API, фильтрует их по заданным критериям, собирает email‑контакты и формирует отчёт в формате CSV.

## Функциональность

Скрипт выполняет следующие действия:

1. **Получает список сделок** из Bitrix24 через REST API.
2. **Фильтрует сделки** по условиям:
   - статус ≠ «Завершена» (`!STAGE_ID: 'WON'`);
   - сумма > 100 000 руб. (`>OPPORTUNITY: 100000`);
   - дата создания ≥ текущей даты минус 30 дней (`>=DATE_CREATE`).
3. **Для каждой отобранной сделки**:
   - получает список контактов, привязанных к сделке;
   - собирает email‑адреса контактов.
4. **Формирует отчёт в CSV** с колонками:
   - `deal_id` — ID сделки;
   - `deal_title` — название сделки;
   - `amount` — сумма сделки;
   - `contact_emails` — список email‑адресов контактов (через запятую).
5. **Сохраняет отчёт** в файл `deals_report.csv`.


Установите зависимости:
```bash
pip install -r requirements.txt
```

## Настройка

1. **Создайте файл `.env`** в корне проекта:
   ```env
    BITRIX_BASE_WEBHOOK=''
    BITRIX_BASE_URL='https://your-domain.ru/rest/1'
   ```
   > Замените URL на актуальный вебхук вашего Bitrix24.
2. **Перейдите в браузер по ссылке: http://127.0.0.1:8000/bitrix/deal**

2. **Проверьте права API**  
   Убедитесь, что вебхук имеет доступ к:
   - `crm.deal.list`;
   - `crm.contact.list`;
   - `crm.contact.get`.

## Запуск

1. Выполните:
   ```bash
   uvicorn src.main:app --reload
   ```
2. Результат будет сохранён в `deals_report.csv` в текущей директории.


## Пример вывода CSV

```csv
deal_id,deal_title,amount,contact_emails
123,Проект А,150000.00,mail1@example.com,mail2@example.com
456,Проект Б,200000.00,mail3@example.com
```

## Структура кода

- **`get_deals()`** — получает и фильтрует сделки.
- **`get_contacts_deal(contact_id)`** — получает email‑адреса контакта.
- **`get_contact_deal(contact_id)`** — получает email‑адреса контакта.
- **`save_deal(deals_data)`** — формирует и сохраняет CSV‑отчёт.
- **Основные параметры фильтрации** заданы в `filter` для `crm.deal.list`.

## Обработка ошибок

- Проверяется наличие полей `result` и `EMAIL` в ответах API.
- Отсутствующие email‑адреса заменяются на пустую строку.
- Ошибки API логируются в консоль.

## Настройки фильтрации


- **Статус сделки**: исключаются сделки со статусом `WON` («Завершена»).
- **Сумма**: только сделки с `OPPORTUNITY > 100000`.
- **Дата создания**: сделки за последние 30 дней (рассчитывается динамически).


## Примечания

- Для работы с часовыми поясами используется `pytz` (опционально).
- CSV сохраняется с кодировкой `utf-8` для поддержки кириллицы.
- Если у сделки несколько контактов, их email‑адреса объединяются через запятую.